<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>新規会員登録</title>

  <script src="config.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <form id="registration-form" novalidate>
      <h2><strong><em>JTB Web販 AWS勉強会 新規会員登録サイト</em></strong></h2>
      <h3>必要事項をご記入の上、登録ボタンを押してください</h3>

      <div class="field">
        <label for="id">ユーザID</label>
        <input autocomplete="off" id="id" inputmode="latin" name="id" placeholder="user-001" required type="text"/>
      </div>

      <div class="field">
        <label for="name">名前</label>
        <input autocomplete="name" id="name" name="name" placeholder="Tetsuya Suzuki" required type="text"/>
      </div>

      <div class="field">
        <label for="email">メールアドレス</label>
        <input autocomplete="email" id="email" name="email" placeholder="tetsuya.suzuki@dxc.com" required type="email"/>
      </div>

      <div class="field">
        <label for="age">年齢</label>
        <input id="age" inputmode="numeric" min="0" name="age" placeholder="35" step="1" type="number"/>
      </div>

      <div class="field">
        <label for="address">住所</label>
        <input id="address" name="address" placeholder="Tokyo, Japan" type="text"/>
      </div>

      <div class="field">
        <label for="tel">電話番号</label>
        <input autocomplete="tel" id="tel" name="tel" placeholder="080-1234-5678" type="tel"/>
      </div>

      <div class="actions">
        <button id="register" type="submit">登録</button>
      </div>

      <p class="note">このフォームは id・name・email・age・address・tel を送信します。</p>

      <div class="link">
        <a href="https://jtb.com/" rel="noopener noreferrer" target="_blank">JTB Web販 AWS勉強会へ</a>
      </div>
    </form>
  </div>

  <!-- 成功モーダル -->
  <div id="success-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="success-title" aria-modal="true">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-content" role="document">
      <button class="modal-close" aria-label="閉じる" data-close="true">&times;</button>
      <h2 id="success-title">登録が完了しました</h2>
      <div id="success-body">
        <p>以下の内容で登録されました：</p>
        <pre id="success-json" class="json-pre"></pre>
      </div>
      <div class="modal-actions">
        <button id="success-ok" class="btn-primary">OK</button>
      </div>
    </div>
  </div>

  <script>
    console.log("[app] registration script loaded v2025-10-18", new Date().toISOString());
    console.log("[app] window.env:", window.env);

    (function initRegistration() {
      if (window.__registrationInitDone) {
        console.log("[app] registration already initialized");
        return;
      }
      window.__registrationInitDone = true;

      window.addEventListener('DOMContentLoaded', () => {
        console.log("[app] DOMContentLoaded fired");

        const form = document.getElementById("registration-form");
        if (!form) {
          console.error("[app] registration form not found (id=registration-form)");
          return;
        }

        const submitButton = document.getElementById("register");
        const endpoint = window.env && window.env.VITE_API_ENDPOINT;
        if (!endpoint || typeof endpoint !== "string") {
          console.error("[app] API endpoint not configured. Check config.js");
          return;
        }
        console.log("[app] using endpoint:", endpoint);

        const validate = ({ id, name, email, age, tel }) => {
          if (!id || !name || !email) {
            alert("すべての必須項目（ID・名前・メールアドレス）を入力してください。");
            return false;
          }
          const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRe.test(email)) {
            alert("メールアドレスの形式が正しくありません。");
            return false;
          }
          if (age !== "" && age !== null && age !== undefined) {
            const n = Number(age);
            if (!Number.isInteger(n) || n < 0) {
              alert("年齢は0以上の整数で入力してください。");
              return false;
            }
          }
          if (tel) {
            const telRe = /^[0-9\-+\s]{8,20}$/;
            if (!telRe.test(tel)) {
              alert("電話番号の形式が正しくありません。");
              return false;
            }
          }
          return true;
        };

        // ここからモーダルユーティリティ（指定の実装）
        function showSuccessModal(obj) {
          const modal = document.getElementById("success-modal");
          const jsonEl = document.getElementById("success-json");
          if (!modal || !jsonEl) {
            alert("登録が完了しました！\n" + JSON.stringify(obj, null, 2));
            return;
          }

          // ラベルマップ: オブジェクトのキー -> 表示ラベル
          const labels = {
            id: "ユーザーID",
            name: "名前",
            email: "メールアドレス",
            age: "年齢",
            address: "住所",
            tel: "電話番号"
          };

          // 表示順の配列（labels にないキーは最後にまとめる）
          const order = ["id", "name", "email", "age", "address", "tel"];

          // obj が文字列や null の場合は従来どおり JSON 表示
          if (!obj || (typeof obj === "string")) {
            jsonEl.textContent = JSON.stringify(obj, null, 2);
            modal.style.display = "flex";
            modal.setAttribute("aria-hidden", "false");
            document.getElementById("success-ok")?.focus();
            return;
          }

          // 定義リストを生成
          const dl = document.createElement("dl");
          dl.style.margin = "0";
          dl.style.padding = "0";

          // ヘルパ: 値を安全に文字列化
          const toText = (v) => {
            if (v === undefined || v === null || v === "") return "（未入力）";
            if (typeof v === "object") return JSON.stringify(v);
            return String(v);
          };

          const used = new Set();
          order.forEach(key => {
            if (Object.prototype.hasOwnProperty.call(obj, key)) {
              const dt = document.createElement("dt");
              dt.textContent = labels[key] || key;
              dt.style.fontWeight = "600";
              dt.style.marginTop = "8px";
              const dd = document.createElement("dd");
              dd.textContent = toText(obj[key]);
              dd.style.margin = "4px 0 0 0";
              dd.style.padding = "8px";
              dd.style.background = "#f6f9f6";
              dd.style.border = "1px solid #c7f0d6";
              dd.style.borderRadius = "6px";
              dl.appendChild(dt);
              dl.appendChild(dd);
              used.add(key);
            }
          });

          // その他のキー（order にないもの）を追加
          Object.keys(obj).forEach(key => {
            if (used.has(key)) return;
            const dt = document.createElement("dt");
            dt.textContent = labels[key] || key;
            dt.style.fontWeight = "600";
            dt.style.marginTop = "8px";
            const dd = document.createElement("dd");
            dd.textContent = toText(obj[key]);
            dd.style.margin = "4px 0 0 0";
            dd.style.padding = "8px";
            dd.style.background = "#f6f9f6";
            dd.style.border = "1px solid #c7f0d6";
            dd.style.borderRadius = "6px";
            dl.appendChild(dt);
            dl.appendChild(dd);
          });

          // jsonEl の中身を置き換え（既存プレ要素を使う）
          jsonEl.innerHTML = ""; // クリア
          jsonEl.appendChild(dl);

          modal.style.display = "flex";
          modal.setAttribute("aria-hidden", "false");
          document.getElementById("success-ok")?.focus();
        }

        function hideSuccessModal() {
          const modal = document.getElementById("success-modal");
          if (!modal) return;
          modal.style.display = "none";
          modal.setAttribute("aria-hidden", "true");
        }

        // モーダル閉じるのイベント
        document.addEventListener("click", function(e){
          const target = e.target;
          if (target && target.dataset && target.dataset.close === "true") {
            hideSuccessModal();
          }
        });
        document.getElementById("success-ok")?.addEventListener("click", hideSuccessModal);
        document.addEventListener("keydown", function(e){
          if (e.key === "Escape") hideSuccessModal();
        });

        // onSubmit
        const onSubmit = async (event) => {
          event.preventDefault();
          try {
            if (submitButton) submitButton.disabled = true;

            const payload = {
              id: document.getElementById("id").value.trim(),
              name: document.getElementById("name").value.trim(),
              email: document.getElementById("email").value.trim(),
              age: (() => {
                const v = document.getElementById("age").value.trim();
                return v === "" ? undefined : Number(v);
              })(),
              address: document.getElementById("address").value.trim() || undefined,
              tel: document.getElementById("tel").value.trim() || undefined
            };

            console.log("[app] submit payload:", payload);

            if (!validate(payload)) return;
            const sendBody = {};
            Object.keys(payload).forEach(k => {
              if (payload[k] !== undefined && payload[k] !== "") sendBody[k] = payload[k];
            });

            console.log("[app] sending:", endpoint, sendBody);

            const res = await fetch(endpoint, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(sendBody),
            });

            console.log("[app] fetch status:", res.status, "ok:", res.ok);
            const ct = res.headers.get("Content-Type") || "";
            let data = null;
            if (ct.includes("application/json")) {
              try { data = await res.json(); } 
              catch (parseErr) { data = { raw: await res.text().catch(()=>"") }; }
            } else {
              data = { raw: await res.text().catch(()=>"") };
            }
            console.log("[app] response data:", data);

            if (res.ok) {
              // data が空／{raw:""} の場合は sendBody を優先表示
              let shown;
              if (!data || (typeof data === 'object' && Object.keys(data).length === 0)) {
                shown = sendBody;
              } else if (typeof data === 'object' && Object.keys(data).length === 1 && data.raw === "") {
                shown = sendBody;
              } else {
                shown = data;
              }

              showSuccessModal(shown);
              form.reset();
            } else {
              const msg = (data && (data.message || data.error)) ? (data.message || data.error) : `ステータス: ${res.status}`;
              alert("登録に失敗しました。 " + msg);
            }
          } catch (e) {
            console.error("[app] network error:", e);
            alert("通信エラーが発生しました: " + (e && e.message ? e.message : String(e)));
          } finally {
            if (submitButton) submitButton.disabled = false;
          }
        };

        // 既にリスナがあるか確認してから登録
        let already = false;
        try {
          if (typeof getEventListeners === 'function') {
            const listeners = getEventListeners(form);
            if (listeners && listeners.submit && listeners.submit.length) already = true;
          }
        } catch (e) {
          // noop
        }
        if (!already) {
          form.addEventListener("submit", onSubmit);
          console.log("[app] submit handler attached");
        } else {
          console.log("[app] submit handler existed already, skip attaching");
        }
      });
    })();
  </script>
</body>
</html>